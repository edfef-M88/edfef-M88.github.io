<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Оплата</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://widget.cloudpayments.ru/bundles/cloudpayments.js"></script>
</head>
<body>
    <script>
        const tg = window.Telegram.WebApp;
        
        function showError(message) {
            window.location.href = 'expired.html';
        }

        try {
            tg.expand();
            tg.ready();

            const params = new URLSearchParams(window.location.search);
            const encodedData = params.get('data');
            
            if (!encodedData) {
                showError('Отсутствуют данные для оплаты');
                return;
            }

            const paymentData = JSON.parse(atob(encodedData));
            const widget = new cp.CloudPayments();
            
            widget.pay('charge', paymentData, {
                onSuccess: function (options) {
                    tg.close();
                },
                onFail: function (reason, options) {
                    showError(reason || 'Ошибка оплаты');
                },
                onComplete: function (paymentResult, options) {
                    if (paymentResult.success) {
                        tg.close();
                    }
                }
            });
        } catch (e) {
            showError(e.message);
        }
    </script>
</body>
</html>
